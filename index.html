<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>ğŸ€„ éº»é›€ç²¾ç®—</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { 
      overscroll-behavior: none; 
      background: #064e3b; 
      font-family: 'Meiryo', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
      font-size: 16px;
    }
    .tab-btn { transition: all 0.2s; }
    .score-input { -webkit-appearance: none; -moz-appearance: textfield; }
    .score-input::-webkit-inner-spin-button { -webkit-appearance: none; }
    .text-xs { font-size: 0.95rem; }
    .text-sm { font-size: 1.1rem; }
    .text-base { font-size: 1.2rem; }
    .text-lg { font-size: 1.4rem; }
    .text-xl { font-size: 1.6rem; }
    .text-2xl { font-size: 1.9rem; }
    .sync-indicator { 
      position: fixed; 
      top: 10px; 
      right: 10px; 
      padding: 4px 8px; 
      border-radius: 4px; 
      font-size: 12px; 
      z-index: 100;
    }
    .room-indicator {
      position: fixed;
      top: 10px;
      left: 10px;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 100;
      background: #1f2937;
      color: #fbbf24;
      cursor: pointer;
    }
  </style>
</head>
<body class="bg-green-900 min-h-screen">
  <div id="syncStatus" class="sync-indicator bg-yellow-600 text-white" style="display:none;">æ¥ç¶šä¸­...</div>
  <div id="roomIndicator" class="room-indicator" style="display:none;" onclick="showRoomLogin()"></div>
  <div id="app" class="max-w-lg mx-auto p-3 pt-10"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, writeBatch, getDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAwyfXpzsGm66aKvH-LG8klfwtIaMqN2jE",
      authDomain: "mahjong-score-21f84.firebaseapp.com",
      projectId: "mahjong-score-21f84",
      storageBucket: "mahjong-score-21f84.firebasestorage.app",
      messagingSenderId: "144373246004",
      appId: "1:144373246004:web:a23ab4f0f1e51e8b55c261"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const YAKUMAN_LIST = [
      'å››æš—åˆ»', 'å›½å£«ç„¡åŒ', 'å¤§ä¸‰å…ƒ', 'å­—ä¸€è‰²', 'å°å››å–œ', 'å¤§å››å–œ',
      'ç·‘ä¸€è‰²', 'æ¸…è€é ­', 'ä¹è“®å®ç‡ˆ', 'å››æ§“å­', 'å¤©å’Œ', 'åœ°å’Œ',
      'å››æš—åˆ»å˜é¨', 'å›½å£«ç„¡åŒ13é¢', 'ç´”æ­£ä¹è“®å®ç‡ˆ', 'ãã®ä»–'
    ];

    const DEFAULT_SETTINGS = {
      basePoint: 30000,
      totalPoint: 100000,
      originPoint: 25000,
      uma: [30, 10, -10, -30],
      pointCoef: 100,
      chipCoef: 100,
      players: ['ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1', 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2', 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼3', 'ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼4'],
      roomName: ''
    };

    let state = {
      roomId: null,
      activeTab: 'input',
      settings: { ...DEFAULT_SETTINGS },
      sessions: [],
      currentSession: {
        id: null,
        date: new Date().toISOString().split('T')[0],
        players: ['', '', '', ''],
        games: [],
        chips: [0, 0, 0, 0],
      },
      showSettings: false,
    };

    let unsubscribeSessions = null;
    let unsubscribeSettings = null;

    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆSHA-256ï¼‰
    async function hashPassword(password) {
      const encoder = new TextEncoder();
      const data = encoder.encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', data);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // éƒ¨å±‹IDãƒ»èªè¨¼æƒ…å ±ç®¡ç†
    function getSavedRoomId() {
      return localStorage.getItem('mj_room_id');
    }

    function getSavedAuthHash() {
      return localStorage.getItem('mj_auth_hash');
    }

    function saveRoomAuth(roomId, authHash) {
      localStorage.setItem('mj_room_id', roomId);
      localStorage.setItem('mj_auth_hash', authHash);
    }

    function clearSavedRoom() {
      localStorage.removeItem('mj_room_id');
      localStorage.removeItem('mj_auth_hash');
    }

    function updateRoomIndicator() {
      const el = document.getElementById('roomIndicator');
      if (state.roomId) {
        const displayName = state.settings.roomName || state.roomId;
        el.textContent = `ğŸ  ${displayName}`;
        el.style.display = 'block';
      } else {
        el.style.display = 'none';
      }
    }

    // éƒ¨å±‹ã‚¯ãƒªãƒƒã‚¯ â†’ ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
    window.showRoomLogin = () => {
      clearSavedRoom();
      state.roomId = null;
      if (unsubscribeSessions) unsubscribeSessions();
      if (unsubscribeSettings) unsubscribeSettings();
      showLoginScreen();
    };

    // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
    function showLoginScreen() {
      document.getElementById('syncStatus').style.display = 'none';
      document.getElementById('roomIndicator').style.display = 'none';
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="flex items-center justify-center min-h-screen">
          <div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm">
            <h1 class="text-2xl font-bold text-white text-center mb-6">ğŸ€„ éº»é›€ç²¾ç®—</h1>
            
            <div id="loginForm">
              <div class="mb-4">
                <label class="text-gray-300 text-sm">éƒ¨å±‹ID</label>
                <input id="roomIdInput" type="text" placeholder="ä¾‹: GV" 
                  class="w-full p-3 rounded bg-gray-700 text-white mt-1">
              </div>
              
              <div class="mb-4">
                <label class="text-gray-300 text-sm">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input id="passwordInput" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" 
                  class="w-full p-3 rounded bg-gray-700 text-white mt-1">
              </div>
              
              <button onclick="enterRoom()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold mb-3">
                å…¥å®¤
              </button>
              
              <div class="text-center text-gray-400 my-3">ã¾ãŸã¯</div>
              
              <button onclick="showCreateRoomForm()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">
                æ–°ã—ã„éƒ¨å±‹ã‚’ä½œæˆ
              </button>
            </div>
            
            <div id="createForm" style="display:none;">
              <div class="mb-4">
                <label class="text-gray-300 text-sm">éƒ¨å±‹IDï¼ˆåŠè§’è‹±æ•°å­—ï¼‰</label>
                <input id="newRoomIdInput" type="text" placeholder="ä¾‹: friday-mahjong" 
                  class="w-full p-3 rounded bg-gray-700 text-white mt-1">
                <p class="text-gray-500 text-xs mt-1">ä»²é–“ã«å…±æœ‰ã™ã‚‹IDã§ã™</p>
              </div>
              
              <div class="mb-4">
                <label class="text-gray-300 text-sm">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input id="newPasswordInput" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" 
                  class="w-full p-3 rounded bg-gray-700 text-white mt-1">
              </div>
              
              <div class="mb-4">
                <label class="text-gray-300 text-sm">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</label>
                <input id="newPasswordConfirmInput" type="password" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª" 
                  class="w-full p-3 rounded bg-gray-700 text-white mt-1">
              </div>
              
              <button onclick="createRoom()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold mb-3">
                éƒ¨å±‹ã‚’ä½œæˆ
              </button>
              
              <button onclick="showLoginForm()" class="w-full bg-gray-600 text-white py-3 rounded-lg">
                æˆ»ã‚‹
              </button>
            </div>
          </div>
        </div>
      `;
    }

    window.showCreateRoomForm = () => {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('createForm').style.display = 'block';
    };

    window.showLoginForm = () => {
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('createForm').style.display = 'none';
    };

    // å…¥å®¤
    window.enterRoom = async () => {
      const roomId = document.getElementById('roomIdInput').value.trim();
      const password = document.getElementById('passwordInput').value;
      
      if (!roomId) { alert('éƒ¨å±‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      if (!password) { alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      
      try {
        const authDoc = await getDoc(doc(db, 'groups', roomId, 'config', 'auth'));
        
        if (!authDoc.exists()) {
          alert('éƒ¨å±‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        const hashedInput = await hashPassword(password);
        const storedHash = authDoc.data().passwordHash;
        
        if (hashedInput !== storedHash) {
          alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
          return;
        }
        
        // å…¥å®¤æˆåŠŸ
        saveRoomAuth(roomId, storedHash);
        state.roomId = roomId;
        document.getElementById('syncStatus').style.display = 'block';
        startRealtimeSync();
        
      } catch (error) {
        console.error('å…¥å®¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      }
    };

    // æ–°è¦éƒ¨å±‹ä½œæˆ
    window.createRoom = async () => {
      const roomId = document.getElementById('newRoomIdInput').value.trim();
      const password = document.getElementById('newPasswordInput').value;
      const passwordConfirm = document.getElementById('newPasswordConfirmInput').value;
      
      if (!roomId) { alert('éƒ¨å±‹IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      if (!roomId.match(/^[a-zA-Z0-9_-]+$/)) { alert('éƒ¨å±‹IDã¯åŠè§’è‹±æ•°å­—ã€ãƒã‚¤ãƒ•ãƒ³ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ä½¿ç”¨ã§ãã¾ã™'); return; }
      if (!password) { alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      if (password.length < 4) { alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„'); return; }
      if (password !== passwordConfirm) { alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“'); return; }
      
      try {
        const authDoc = await getDoc(doc(db, 'groups', roomId, 'config', 'auth'));
        
        if (authDoc.exists()) {
          alert('ã“ã®éƒ¨å±‹IDã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™');
          return;
        }
        
        const hashedPassword = await hashPassword(password);
        await setDoc(doc(db, 'groups', roomId, 'config', 'auth'), {
          passwordHash: hashedPassword,
          createdAt: new Date().toISOString()
        });
        
        await setDoc(doc(db, 'groups', roomId, 'config', 'settings'), {
          ...DEFAULT_SETTINGS,
          roomName: roomId
        });
        
        saveRoomAuth(roomId, hashedPassword);
        state.roomId = roomId;
        document.getElementById('syncStatus').style.display = 'block';
        startRealtimeSync();
        
        alert(`éƒ¨å±‹ã€Œ${roomId}ã€ã‚’ä½œæˆã—ã¾ã—ãŸï¼\n\nä»²é–“ã«ã¯ä»¥ä¸‹ã‚’å…±æœ‰ã—ã¦ãã ã•ã„ï¼š\néƒ¨å±‹ID: ${roomId}\nãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ï¼ˆè¨­å®šã—ãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰`);
        
      } catch (error) {
        console.error('éƒ¨å±‹ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      }
    };

    // åŒæœŸçŠ¶æ…‹è¡¨ç¤º
    function updateSyncStatus(status) {
      const el = document.getElementById('syncStatus');
      if (status === 'connected') {
        el.className = 'sync-indicator bg-green-600 text-white';
        el.textContent = 'ğŸŸ¢ åŒæœŸä¸­';
      } else if (status === 'syncing') {
        el.className = 'sync-indicator bg-yellow-600 text-white';
        el.textContent = 'ğŸ”„ ä¿å­˜ä¸­...';
      } else if (status === 'error') {
        el.className = 'sync-indicator bg-red-600 text-white';
        el.textContent = 'ğŸ”´ ã‚¨ãƒ©ãƒ¼';
      } else {
        el.className = 'sync-indicator bg-yellow-600 text-white';
        el.textContent = 'æ¥ç¶šä¸­...';
      }
    }

    // Firebaseæ“ä½œ
    async function saveSettingsToFirebase() {
      if (!state.roomId) return;
      try {
        await setDoc(doc(db, 'groups', state.roomId, 'config', 'settings'), state.settings);
      } catch (e) { console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', e); }
    }

    async function saveSessionToFirebase(session) {
      if (!state.roomId) return;
      try {
        updateSyncStatus('syncing');
        await setDoc(doc(db, 'groups', state.roomId, 'sessions', String(session.id)), session);
        updateSyncStatus('connected');
      } catch (e) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        updateSyncStatus('error');
      }
    }

    async function deleteSessionFromFirebase(sessionId) {
      if (!state.roomId) return;
      try {
        updateSyncStatus('syncing');
        await deleteDoc(doc(db, 'groups', state.roomId, 'sessions', String(sessionId)));
        updateSyncStatus('connected');
      } catch (e) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e);
        updateSyncStatus('error');
      }
    }

    function startRealtimeSync() {
      if (!state.roomId) return;
      
      if (unsubscribeSessions) unsubscribeSessions();
      if (unsubscribeSettings) unsubscribeSettings();

      const sessionsRef = collection(db, 'groups', state.roomId, 'sessions');
      unsubscribeSessions = onSnapshot(sessionsRef, (snapshot) => {
        state.sessions = [];
        snapshot.forEach((doc) => state.sessions.push(doc.data()));
        state.sessions.sort((a, b) => b.date.localeCompare(a.date));
        updateSyncStatus('connected');
        render();
      }, (error) => {
        console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
        updateSyncStatus('error');
      });

      unsubscribeSettings = onSnapshot(doc(db, 'groups', state.roomId, 'config', 'settings'), (doc) => {
        if (doc.exists()) {
          state.settings = { ...DEFAULT_SETTINGS, ...doc.data() };
          if (state.currentSession.players.every(p => p === '' || p.startsWith('ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼'))) {
            state.currentSession.players = [...state.settings.players];
          }
          updateRoomIndicator();
          render();
        }
      });
    }

    // è¨ˆç®—é–¢æ•°
    function checkTotal(scores) {
      return scores.reduce((a,b) => a+b, 0) === state.settings.totalPoint;
    }

    function getRanks(scores) {
      const indexed = scores.map((s,i) => ({s,i}));
      indexed.sort((a,b) => b.s - a.s);
      const ranks = [0,0,0,0];
      indexed.forEach((x,r) => ranks[x.i] = r + 1);
      return ranks;
    }

    function calcGame(scores) {
      if (!checkTotal(scores)) return null;
      const ranks = getRanks(scores);
      const oka = ((state.settings.basePoint - state.settings.originPoint) * 4) / 1000;
      const results = scores.map((score, i) => {
        const base = (score - state.settings.basePoint) / 1000;
        const uma = state.settings.uma[ranks[i] - 1];
        const okaBonus = ranks[i] === 1 ? oka : 0;
        return base + uma + okaBonus;
      });
      return { ranks, results };
    }

    function calcSession(session) {
      const totals = [0,0,0,0];
      const rankCounts = [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];
      session.games.forEach(g => {
        const r = calcGame(g.scores);
        if (r) {
          r.results.forEach((v,i) => totals[i] += v);
          r.ranks.forEach((v,i) => rankCounts[i][v-1]++);
        }
      });
      return session.players.map((p,i) => ({
        player: p || `P${i+1}`,
        pointTotal: totals[i],
        pointAmount: totals[i] * state.settings.pointCoef,
        chipCount: session.chips[i],
        chipAmount: session.chips[i] * state.settings.chipCoef,
        total: totals[i] * state.settings.pointCoef + session.chips[i] * state.settings.chipCoef,
        rankCounts: rankCounts[i],
      }));
    }

    function getAllYakuman() {
      const list = [];
      state.sessions.forEach(session => {
        session.games.forEach((game) => {
          if (game.yakuman && game.yakuman.length > 0) {
            game.yakuman.forEach(yk => list.push({ date: session.date, ...yk }));
          }
        });
      });
      return list.sort((a,b) => b.date.localeCompare(a.date));
    }

    function getYakumanStats() {
      const stats = {};
      state.settings.players.forEach(p => stats[p] = { count: 0 });
      getAllYakuman().forEach(yk => {
        if (stats[yk.player]) stats[yk.player].count++;
      });
      return stats;
    }

    function getPlayerStats() {
      const stats = {};
      state.sessions.forEach(session => {
        session.games.forEach(game => {
          const r = calcGame(game.scores);
          if (!r) return;
          session.players.forEach((player, i) => {
            if (!player) return;
            if (!stats[player]) {
              stats[player] = { name: player, games: 0, ranks: [0,0,0,0], totalPoints: 0, totalChips: 0 };
            }
            stats[player].games++;
            stats[player].ranks[r.ranks[i] - 1]++;
            stats[player].totalPoints += r.results[i];
          });
        });
        session.players.forEach((player, i) => {
          if (player && stats[player]) stats[player].totalChips += session.chips[i];
        });
      });

      const yakumanStats = getYakumanStats();
      Object.values(stats).forEach(s => {
        s.winRate = s.games > 0 ? ((s.ranks[0] / s.games) * 100).toFixed(1) : 0;
        s.avgRank = s.games > 0 ? ((s.ranks[0]*1 + s.ranks[1]*2 + s.ranks[2]*3 + s.ranks[3]*4) / s.games).toFixed(2) : 0;
        s.totalAmount = s.totalPoints * state.settings.pointCoef + s.totalChips * state.settings.chipCoef;
        s.yakumanCount = yakumanStats[s.name] ? yakumanStats[s.name].count : 0;
      });

      return Object.values(stats).sort((a,b) => b.totalAmount - a.totalAmount);
    }

    // UI
    function render() {
      if (!state.roomId) {
        showLoginScreen();
        return;
      }
      
      const app = document.getElementById('app');
      app.innerHTML = `
        <h1 class="text-xl font-bold text-white text-center mb-3">ğŸ€„ éº»é›€ç²¾ç®—</h1>
        <div class="grid grid-cols-6 gap-1 mb-4">
          ${['input:ğŸ“å…¥åŠ›', 'history:ğŸ“šå±¥æ­´', 'report:ğŸ“Šæˆç¸¾', 'yakuman:ğŸ€„å½¹æº€', 'ranking:ğŸ†é †ä½', 'data:ğŸ’¾ç®¡ç†'].map(t => {
            const [id, label] = t.split(':');
            return `<button onclick="setTab('${id}')" class="tab-btn py-3 rounded text-sm text-center ${state.activeTab === id ? 'bg-yellow-600 text-white' : 'bg-gray-700 text-gray-300'}">${label}</button>`;
          }).join('')}
        </div>
        <div id="content"></div>
      `;
      const content = document.getElementById('content');
      if (state.activeTab === 'input') renderInput(content);
      else if (state.activeTab === 'history') renderHistory(content);
      else if (state.activeTab === 'report') renderReport(content);
      else if (state.activeTab === 'yakuman') renderYakuman(content);
      else if (state.activeTab === 'ranking') renderRanking(content);
      else if (state.activeTab === 'data') renderData(content);
    }

    window.setTab = (tab) => { state.activeTab = tab; render(); };

    function renderInput(el) {
      const cs = state.currentSession;
      const chipTotal = cs.chips.reduce((a,b) => a+b, 0);
      const chipValid = chipTotal === 0;

      el.innerHTML = `
        <div class="flex justify-end mb-2">
          <button onclick="toggleSettings()" class="bg-yellow-600 text-white px-3 py-1 rounded text-sm">âš™ï¸è¨­å®š</button>
        </div>
        ${state.showSettings ? `
        <div class="bg-gray-800 rounded-lg p-3 mb-3">
          <div class="mb-3">
            <label class="text-gray-300 text-xs">éƒ¨å±‹å</label>
            <input type="text" value="${state.settings.roomName || ''}" onchange="updateSetting('roomName', this.value)" class="w-full p-2 rounded bg-gray-700 text-white" placeholder="è¡¨ç¤ºç”¨ã®éƒ¨å±‹å">
          </div>
          <div class="mb-3">
            <label class="text-gray-300 text-xs">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</label>
            <div class="grid grid-cols-2 gap-2 mt-1">
              ${state.settings.players.map((p,i) => `<input value="${p}" onchange="updatePlayerSetting(${i}, this.value)" placeholder="ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼${i+1}" class="p-2 rounded bg-gray-700 text-white text-sm">`).join('')}
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div><label class="text-gray-300 text-xs">åŸºæº–ç‚¹</label><input type="number" value="${state.settings.basePoint}" onchange="updateSetting('basePoint', this.value)" class="w-full p-2 rounded bg-gray-700 text-white score-input"></div>
            <div><label class="text-gray-300 text-xs">åˆè¨ˆç‚¹</label><input type="number" value="${state.settings.totalPoint}" onchange="updateSetting('totalPoint', this.value)" class="w-full p-2 rounded bg-gray-700 text-white score-input"></div>
            <div><label class="text-gray-300 text-xs">ç‚¹æ•°ä¿‚æ•°</label><input type="number" value="${state.settings.pointCoef}" onchange="updateSetting('pointCoef', this.value)" class="w-full p-2 rounded bg-gray-700 text-white score-input"></div>
            <div><label class="text-gray-300 text-xs">ãƒãƒƒãƒ—ä¿‚æ•°</label><input type="number" value="${state.settings.chipCoef}" onchange="updateSetting('chipCoef', this.value)" class="w-full p-2 rounded bg-gray-700 text-white score-input"></div>
          </div>
          <div class="mt-2">
            <label class="text-gray-300 text-xs">ã‚¦ãƒ</label>
            <div class="grid grid-cols-4 gap-1">
              ${state.settings.uma.map((u,i) => `<input type="number" value="${u}" onchange="updateUma(${i}, this.value)" class="p-1 rounded bg-gray-700 text-white text-center text-sm score-input">`).join('')}
            </div>
          </div>
        </div>
        ` : ''}
        <div class="bg-gray-800 rounded-lg p-3 mb-3">
          <input type="date" value="${cs.date}" onchange="updateDate(this.value)" class="w-full p-2 rounded bg-gray-700 text-white mb-2">
          <div class="grid grid-cols-4 gap-1">
            ${cs.players.map((p,i) => `<input value="${p}" onchange="updatePlayer(${i}, this.value)" placeholder="æ°å${i+1}" class="p-2 rounded bg-gray-700 text-white text-sm">`).join('')}
          </div>
        </div>
        <div class="bg-gray-800 rounded-lg p-3 mb-3">
          <div class="flex justify-between items-center mb-2">
            <span class="text-white font-bold text-sm">ã‚²ãƒ¼ãƒ </span>
            <button onclick="addGame()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">+è¿½åŠ </button>
          </div>
          ${cs.games.length === 0 ? '<p class="text-gray-400 text-center py-4 text-sm">ã‚²ãƒ¼ãƒ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>' : 
            cs.games.map((g,gi) => {
              const valid = checkTotal(g.scores);
              const result = calcGame(g.scores);
              const total = g.scores.reduce((a,b) => a+b, 0);
              const yakumanList = g.yakuman || [];
              return `
              <div class="p-2 rounded mb-2 ${valid ? 'bg-gray-700' : 'bg-red-900'}">
                <div class="flex justify-between items-center mb-1">
                  <span class="text-white text-base">#${gi+1}</span>
                  <div class="flex items-center gap-2">
                    <span class="text-sm ${valid ? 'text-green-400' : 'text-red-400'}">è¨ˆ:${(total/100).toLocaleString()}</span>
                    <button onclick="removeGame(${gi})" class="text-red-400 text-sm">âœ•</button>
                  </div>
                </div>
                <div class="grid grid-cols-4 gap-1 mb-2">
                  ${g.scores.map((s,pi) => `
                    <div>
                      <div class="text-gray-300 text-xs text-center mb-1 truncate">${cs.players[pi] || 'P'+(pi+1)}</div>
                      <input type="number" value="${s ? s/100 : ''}" onchange="updateScore(${gi},${pi},this.value)" placeholder="250" class="w-full p-2 rounded bg-gray-600 text-white text-center text-base score-input">
                      ${result ? `<div class="text-sm text-center mt-1"><span class="text-yellow-400">${result.ranks[pi]}ä½</span> <span class="${result.results[pi]>=0?'text-green-400':'text-red-400'}">${result.results[pi]>=0?'+':''}${result.results[pi]}</span></div>` : ''}
                    </div>
                  `).join('')}
                </div>
                <div class="border-t border-gray-600 pt-2 mt-2">
                  <div class="flex justify-between items-center mb-1">
                    <span class="text-yellow-400 text-xs font-bold">ğŸ€„ å½¹æº€</span>
                    <button onclick="addYakuman(${gi})" class="bg-yellow-600 text-white px-2 py-0.5 rounded text-xs">+è¿½åŠ </button>
                  </div>
                  ${yakumanList.map((yk, yi) => `
                    <div class="bg-gray-600 rounded p-2 mb-1 text-xs">
                      <div class="flex justify-between items-center">
                        <span class="text-yellow-300 font-bold">${yk.yaku}</span>
                        <button onclick="removeYakuman(${gi},${yi})" class="text-red-400">âœ•</button>
                      </div>
                      <div class="text-gray-300">${yk.player} / ${yk.type}${yk.type === 'ãƒ­ãƒ³' && yk.from ? ` â† ${yk.from}` : ''}</div>
                    </div>
                  `).join('')}
                </div>
                <button onclick="saveGame(${gi})" class="w-full mt-2 ${valid ? 'bg-green-600' : 'bg-gray-500'} text-white py-2 rounded font-bold text-sm">${valid ? 'ğŸ’¾ ã“ã®ã‚²ãƒ¼ãƒ ã‚’ä¿å­˜' : 'âš ï¸ åˆè¨ˆãŒä¸æ­£ã§ã™'}</button>
              </div>`;
            }).join('')}
        </div>
        <div class="rounded-lg p-3 mb-3 ${chipValid ? 'bg-gray-800' : 'bg-red-900'}">
          <div class="flex justify-between items-center mb-2">
            <span class="text-white font-bold text-sm">ãƒãƒƒãƒ—</span>
            <span class="text-xs ${chipValid ? 'text-green-400' : 'text-red-400'}">è¨ˆ:${chipTotal}</span>
          </div>
          <div class="grid grid-cols-4 gap-1">
            ${cs.chips.map((c,i) => `
              <div>
                <div class="text-gray-300 text-sm text-center mb-1 truncate">${cs.players[i] || 'P'+(i+1)}</div>
                <input type="number" value="${c||''}" onchange="updateChip(${i},this.value)" placeholder="0" class="p-2 rounded bg-gray-700 text-white text-center text-base score-input w-full">
              </div>
            `).join('')}
          </div>
        </div>
        ${cs.games.length > 0 ? `
        <div class="bg-gray-800 rounded-lg p-3 mb-3 overflow-x-auto">
          <table class="w-full text-white text-xs">
            <thead><tr class="border-b border-gray-600">
              <th class="text-left p-1">åå‰</th><th class="text-right p-1">pt</th><th class="text-right p-1">å††</th><th class="text-right p-1">chip</th><th class="text-right p-1">è¨ˆ</th>
            </tr></thead>
            <tbody>
              ${calcSession(cs).map(r => `
                <tr class="border-b border-gray-700">
                  <td class="p-1">${r.player}</td>
                  <td class="text-right p-1 ${r.pointTotal>=0?'text-green-400':'text-red-400'}">${r.pointTotal}</td>
                  <td class="text-right p-1 ${r.pointAmount>=0?'text-green-400':'text-red-400'}">${r.pointAmount.toLocaleString()}</td>
                  <td class="text-right p-1 ${r.chipAmount>=0?'text-green-400':'text-red-400'}">${r.chipAmount.toLocaleString()}</td>
                  <td class="text-right p-1 font-bold ${r.total>=0?'text-green-400':'text-red-400'}">${r.total.toLocaleString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        ` : ''}
        <button onclick="saveSession()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold">ğŸ’¾ ä¿å­˜</button>
      `;
    }

    window.toggleSettings = () => { state.showSettings = !state.showSettings; render(); };
    window.updateSetting = (key, val) => { 
      if (key === 'roomName') {
        state.settings[key] = val;
      } else {
        state.settings[key] = parseInt(val) || 0;
      }
      saveSettingsToFirebase(); 
      render(); 
    };
    window.updatePlayerSetting = (i, val) => {
      state.settings.players[i] = val;
      saveSettingsToFirebase();
      render();
    };
    window.updateUma = (i, val) => { state.settings.uma[i] = parseInt(val) || 0; saveSettingsToFirebase(); render(); };
    window.updateDate = (val) => { state.currentSession.date = val; render(); };
    window.updatePlayer = (i, val) => { state.currentSession.players[i] = val; render(); };
    window.addGame = () => { state.currentSession.games.push({scores:[0,0,0,0], yakuman: []}); render(); };
    window.removeGame = (i) => { state.currentSession.games.splice(i,1); render(); };
    window.updateScore = (gi, pi, val) => { state.currentSession.games[gi].scores[pi] = (parseInt(val)||0) * 100; render(); };
    window.updateChip = (i, val) => { state.currentSession.chips[i] = parseInt(val)||0; render(); };

    window.saveGame = async (gi) => {
      const game = state.currentSession.games[gi];
      if (!checkTotal(game.scores)) {
        alert('åˆè¨ˆãŒ' + state.settings.totalPoint + 'ç‚¹ã«ãªã£ã¦ã„ã¾ã›ã‚“');
        return;
      }
      const cs = state.currentSession;
      const toSave = { ...cs, id: cs.date, savedAt: new Date().toISOString() };
      await saveSessionToFirebase(toSave);
      alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
      render();
    };

    window.addYakuman = (gi) => {
      const players = state.currentSession.players;
      document.body.insertAdjacentHTML('beforeend', `
        <div id="yakumanModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
          <div class="bg-gray-800 rounded-lg p-4 w-full max-w-sm">
            <h3 class="text-white font-bold mb-3">ğŸ€„ å½¹æº€ã‚’è¿½åŠ </h3>
            <div class="mb-3">
              <label class="text-gray-300 text-sm">å’Œäº†è€…</label>
              <select id="yk_player" class="w-full p-2 rounded bg-gray-700 text-white">
                ${players.map(p => `<option value="${p}">${p}</option>`).join('')}
              </select>
            </div>
            <div class="mb-3">
              <label class="text-gray-300 text-sm">å½¹å</label>
              <select id="yk_yaku" class="w-full p-2 rounded bg-gray-700 text-white" onchange="document.getElementById('yk_yaku_other').classList.toggle('hidden', this.value !== 'ãã®ä»–')">
                ${YAKUMAN_LIST.map(y => `<option value="${y}">${y}</option>`).join('')}
              </select>
              <input id="yk_yaku_other" type="text" placeholder="ãã®ä»–ã®å½¹å" class="w-full p-2 rounded bg-gray-700 text-white mt-1 hidden">
            </div>
            <div class="mb-3">
              <label class="text-gray-300 text-sm">ãƒ„ãƒ¢/ãƒ­ãƒ³</label>
              <select id="yk_type" class="w-full p-2 rounded bg-gray-700 text-white" onchange="document.getElementById('yk_from_div').classList.toggle('hidden', this.value !== 'ãƒ­ãƒ³')">
                <option value="ãƒ„ãƒ¢">ãƒ„ãƒ¢</option>
                <option value="ãƒ­ãƒ³">ãƒ­ãƒ³</option>
              </select>
            </div>
            <div id="yk_from_div" class="mb-3 hidden">
              <label class="text-gray-300 text-sm">æ”¾éŠƒè€…</label>
              <select id="yk_from" class="w-full p-2 rounded bg-gray-700 text-white">
                ${players.map(p => `<option value="${p}">${p}</option>`).join('')}
              </select>
            </div>
            <div class="flex gap-2">
              <button onclick="confirmYakuman(${gi})" class="flex-1 bg-yellow-600 text-white py-2 rounded font-bold">è¿½åŠ </button>
              <button onclick="document.getElementById('yakumanModal').remove()" class="flex-1 bg-gray-600 text-white py-2 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
          </div>
        </div>
      `);
    };

    window.confirmYakuman = (gi) => {
      let yaku = document.getElementById('yk_yaku').value;
      if (yaku === 'ãã®ä»–') yaku = document.getElementById('yk_yaku_other').value || 'ãã®ä»–';
      const type = document.getElementById('yk_type').value;
      const from = type === 'ãƒ­ãƒ³' ? document.getElementById('yk_from').value : null;
      if (!state.currentSession.games[gi].yakuman) state.currentSession.games[gi].yakuman = [];
      state.currentSession.games[gi].yakuman.push({
        player: document.getElementById('yk_player').value,
        yaku, type, from
      });
      document.getElementById('yakumanModal').remove();
      render();
    };

    window.removeYakuman = (gi, yi) => { state.currentSession.games[gi].yakuman.splice(yi, 1); render(); };

    window.saveSession = async () => {
      const cs = state.currentSession;
      if (cs.games.length === 0) { alert('ã‚²ãƒ¼ãƒ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„'); return; }
      if (cs.games.filter(g => checkTotal(g.scores)).length === 0) { alert('æœ‰åŠ¹ãªã‚²ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      const toSave = { ...cs, id: cs.date, savedAt: new Date().toISOString() };
      await saveSessionToFirebase(toSave);
      state.currentSession = { id: null, date: new Date().toISOString().split('T')[0], players: [...state.settings.players], games: [], chips: [0,0,0,0] };
      alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
      render();
    };

    function renderHistory(el) {
      if (state.sessions.length === 0) { el.innerHTML = '<p class="text-gray-400 text-center py-8">å±¥æ­´ãªã—</p>'; return; }
      el.innerHTML = [...state.sessions].sort((a,b) => b.date.localeCompare(a.date)).map(s => {
        const results = calcSession(s);
        const ykCount = s.games.reduce((sum, g) => sum + (g.yakuman ? g.yakuman.length : 0), 0);
        return `
        <div class="bg-gray-800 rounded-lg p-3 mb-3">
          <div class="flex justify-between items-center mb-2">
            <div><span class="text-white font-bold">${s.date}</span>${ykCount > 0 ? `<span class="ml-2 bg-yellow-600 text-white px-2 py-0.5 rounded text-xs">å½¹æº€${ykCount}</span>` : ''}</div>
            <button onclick="editSession('${s.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">ç·¨é›†</button>
          </div>
          <div class="grid grid-cols-2 gap-2 mb-2">
            ${results.map(r => `<div class="bg-gray-700 rounded p-2"><div class="text-gray-300 text-sm">${r.player}</div><div class="font-bold ${r.total>=0?'text-green-400':'text-red-400'}">${r.total>=0?'+':''}${r.total.toLocaleString()}å††</div></div>`).join('')}
          </div>
          <div class="text-right">
            <button onclick="deleteSession('${s.id}')" class="text-red-400 text-sm">ğŸ—‘ï¸ å‰Šé™¤</button>
          </div>
        </div>`;
      }).join('');
    }

    window.editSession = (id) => {
      const s = state.sessions.find(x => String(x.id) === String(id));
      if (s) { state.currentSession = JSON.parse(JSON.stringify(s)); state.activeTab = 'input'; render(); }
    };
    window.deleteSession = async (id) => { if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) await deleteSessionFromFirebase(id); };

    function renderReport(el) {
      const stats = getPlayerStats();
      el.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-3 mb-3 overflow-x-auto">
          <table class="w-full text-white text-xs">
            <thead><tr class="border-b border-gray-600"><th class="text-left p-1">åå‰</th><th class="text-right p-1">å±€æ•°</th><th class="text-right p-1">å‹ç‡</th><th class="text-right p-1">å¹³é †</th><th class="text-right p-1">å½¹æº€</th><th class="text-right p-1">åæ”¯</th></tr></thead>
            <tbody>${stats.map(s => `<tr class="border-b border-gray-700"><td class="p-1">${s.name}</td><td class="text-right p-1">${s.games}</td><td class="text-right p-1">${s.winRate}%</td><td class="text-right p-1">${s.avgRank}</td><td class="text-right p-1 text-yellow-400">${s.yakumanCount}</td><td class="text-right p-1 font-bold ${s.totalAmount>=0?'text-green-400':'text-red-400'}">${s.totalAmount.toLocaleString()}</td></tr>`).join('')}</tbody>
          </table>
        </div>
        <div class="bg-gray-800 rounded-lg p-3">
          <h3 class="text-white font-bold mb-2 text-sm">é †ä½åˆ†å¸ƒ</h3>
          ${stats.map(s => `<div class="mb-2"><div class="text-gray-300 text-xs mb-1">${s.name}</div><div class="flex gap-1"><span class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">1ä½:${s.ranks[0]}</span><span class="bg-gray-500 text-white px-2 py-1 rounded text-xs">2ä½:${s.ranks[1]}</span><span class="bg-orange-700 text-white px-2 py-1 rounded text-xs">3ä½:${s.ranks[2]}</span><span class="bg-gray-700 text-white px-2 py-1 rounded text-xs">4ä½:${s.ranks[3]}</span></div></div>`).join('')}
        </div>
      `;
    }

    function renderYakuman(el) {
      const all = getAllYakuman();
      const stats = getYakumanStats();
      el.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-3 mb-3">
          <h3 class="text-white font-bold mb-2">ğŸ€„ å½¹æº€å›æ•°</h3>
          <div class="grid grid-cols-2 gap-2">
            ${Object.entries(stats).map(([name, data]) => `<div class="bg-gray-700 rounded p-2 text-center"><div class="text-gray-300 text-sm">${name}</div><div class="text-yellow-400 text-2xl font-bold">${data.count}</div></div>`).join('')}
          </div>
        </div>
        <div class="bg-gray-800 rounded-lg p-3">
          <h3 class="text-white font-bold mb-2">ğŸ“œ å½¹æº€å±¥æ­´</h3>
          ${all.length === 0 ? '<p class="text-gray-400 text-center py-4 text-sm">å½¹æº€è¨˜éŒ²ãªã—</p>' : all.map(yk => `<div class="bg-gray-700 rounded p-2 mb-2"><div class="flex justify-between items-center"><span class="text-yellow-400 font-bold">${yk.yaku}</span><span class="text-gray-400 text-xs">${yk.date}</span></div><div class="text-gray-300 text-sm">${yk.player} / ${yk.type}${yk.type === 'ãƒ­ãƒ³' && yk.from ? ` â† ${yk.from}` : ''}</div></div>`).join('')}
        </div>
      `;
    }

    function renderRanking(el) {
      const stats = getPlayerStats();
      const medal = (i) => i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':i===3?'4ï¸âƒ£':`${i+1}.`;
      el.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-3 mb-3"><h3 class="text-white font-bold mb-2">ğŸ’° åæ”¯</h3>${stats.map((s,i) => `<div class="flex justify-between py-1 border-b border-gray-700"><span class="text-white">${medal(i)} ${s.name}</span><span class="${s.totalAmount>=0?'text-green-400':'text-red-400'}">${s.totalAmount.toLocaleString()}å††</span></div>`).join('')}</div>
        <div class="bg-gray-800 rounded-lg p-3 mb-3"><h3 class="text-white font-bold mb-2">ğŸ¯ å‹ç‡</h3>${[...stats].sort((a,b) => b.winRate - a.winRate).map((s,i) => `<div class="flex justify-between py-1 border-b border-gray-700"><span class="text-white">${medal(i)} ${s.name}</span><span class="text-yellow-400">${s.winRate}%</span></div>`).join('')}</div>
        <div class="bg-gray-800 rounded-lg p-3 mb-3"><h3 class="text-white font-bold mb-2">ğŸ€„ å½¹æº€</h3>${[...stats].sort((a,b) => b.yakumanCount - a.yakumanCount).map((s,i) => `<div class="flex justify-between py-1 border-b border-gray-700"><span class="text-white">${medal(i)} ${s.name}</span><span class="text-yellow-400">${s.yakumanCount}å›</span></div>`).join('')}</div>
        <div class="bg-gray-800 rounded-lg p-3"><h3 class="text-white font-bold mb-2">ğŸ“Š å¹³å‡é †ä½</h3>${[...stats].sort((a,b) => a.avgRank - b.avgRank).map((s,i) => `<div class="flex justify-between py-1 border-b border-gray-700"><span class="text-white">${medal(i)} ${s.name}</span><span class="text-blue-400">${s.avgRank}</span></div>`).join('')}</div>
      `;
    }

    function renderData(el) {
      el.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-4 mb-3">
          <h3 class="text-white font-bold mb-2">ğŸ  éƒ¨å±‹æƒ…å ±</h3>
          <p class="text-gray-300 text-sm">éƒ¨å±‹ID: <span class="text-yellow-400 font-mono">${state.roomId}</span></p>
          <p class="text-gray-400 text-xs mt-1">ã“ã®IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ä»²é–“ã«å…±æœ‰ã—ã¦ãã ã•ã„</p>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 mb-3">
          <h3 class="text-white font-bold mb-2">ğŸ“ˆ çµ±è¨ˆ</h3>
          <div class="grid grid-cols-3 gap-2 text-center">
            <div class="bg-gray-700 rounded p-2"><div class="text-2xl font-bold text-white">${state.sessions.length}</div><div class="text-gray-400 text-xs">ã‚»ãƒƒã‚·ãƒ§ãƒ³</div></div>
            <div class="bg-gray-700 rounded p-2"><div class="text-2xl font-bold text-white">${state.sessions.reduce((s,x) => s + x.games.length, 0)}</div><div class="text-gray-400 text-xs">ã‚²ãƒ¼ãƒ </div></div>
            <div class="bg-gray-700 rounded p-2"><div class="text-2xl font-bold text-yellow-400">${getAllYakuman().length}</div><div class="text-gray-400 text-xs">å½¹æº€</div></div>
          </div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 mb-3">
          <h3 class="text-white font-bold mb-2">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
          <button onclick="exportData()" class="w-full bg-blue-600 text-white py-2 rounded">JSONã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 mb-3">
          <h3 class="text-white font-bold mb-2">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
          <label class="block w-full bg-green-600 text-white py-2 rounded text-center cursor-pointer mb-2">JSONã‹ã‚‰å¾©å…ƒ<input type="file" accept=".json" onchange="importJSON(event)" class="hidden"></label>
          <div id="importJSONPreview"></div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 mb-3">
          <h3 class="text-white font-bold mb-2">ğŸ“‹ éå»ãƒ‡ãƒ¼ã‚¿ï¼ˆExcel/CSVï¼‰</h3>
          <p class="text-gray-400 text-xs mb-2">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼: ${state.settings.players.join(', ')}</p>
          <label class="block w-full bg-purple-600 text-white py-2 rounded text-center cursor-pointer mb-2">ç‚¹æ•°ãƒ‡ãƒ¼ã‚¿èª­è¾¼<input type="file" accept=".xlsx,.xls,.csv" onchange="importLegacy(event)" class="hidden"></label>
          <label class="block w-full bg-orange-600 text-white py-2 rounded text-center cursor-pointer">ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿èª­è¾¼<input type="file" accept=".xlsx,.xls,.csv" onchange="importChip(event)" class="hidden"></label>
          <div id="importPreview"></div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 mb-3">
          <h3 class="text-white font-bold mb-2">ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
          <button onclick="showChangePassword()" class="w-full bg-yellow-600 text-white py-2 rounded">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´</button>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 mb-3">
          <h3 class="text-white font-bold mb-2">âš ï¸ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</h3>
          <p class="text-gray-400 text-xs mb-2">ã“ã®éƒ¨å±‹ã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™</p>
          <button onclick="deleteAllData()" class="w-full bg-red-600 text-white py-2 rounded">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
        </div>
      `;
    }

    window.showChangePassword = () => {
      document.body.insertAdjacentHTML('beforeend', `
        <div id="passwordModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
          <div class="bg-gray-800 rounded-lg p-4 w-full max-w-sm">
            <h3 class="text-white font-bold mb-3">ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´</h3>
            <div class="mb-3">
              <label class="text-gray-300 text-sm">æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
              <input id="newPw" type="password" class="w-full p-2 rounded bg-gray-700 text-white mt-1">
            </div>
            <div class="mb-3">
              <label class="text-gray-300 text-sm">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª</label>
              <input id="newPwConfirm" type="password" class="w-full p-2 rounded bg-gray-700 text-white mt-1">
            </div>
            <div class="flex gap-2">
              <button onclick="changePassword()" class="flex-1 bg-green-600 text-white py-2 rounded font-bold">å¤‰æ›´</button>
              <button onclick="document.getElementById('passwordModal').remove()" class="flex-1 bg-gray-600 text-white py-2 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
          </div>
        </div>
      `);
    };

    window.changePassword = async () => {
      const newPw = document.getElementById('newPw').value;
      const newPwConfirm = document.getElementById('newPwConfirm').value;
      if (!newPw || newPw.length < 4) { alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯4æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„'); return; }
      if (newPw !== newPwConfirm) { alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“'); return; }
      
      try {
        const hashedPassword = await hashPassword(newPw);
        await setDoc(doc(db, 'groups', state.roomId, 'config', 'auth'), {
          passwordHash: hashedPassword,
          updatedAt: new Date().toISOString()
        }, { merge: true });
        saveRoomAuth(state.roomId, hashedPassword);
        document.getElementById('passwordModal').remove();
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
      }
    };

    window.exportData = () => {
      const data = { roomId: state.roomId, sessions: state.sessions, settings: state.settings };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = `mahjong_${state.roomId}_${new Date().toISOString().split('T')[0]}.json`; a.click();
    };

    let pendingJSONImport = null;

    window.importJSON = (e) => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          if (!data.sessions || !Array.isArray(data.sessions)) {
            alert('ç„¡åŠ¹ãªJSONãƒ•ã‚¡ã‚¤ãƒ«ã§ã™'); return;
          }
          pendingJSONImport = data;
          document.getElementById('importJSONPreview').innerHTML = `
            <div class="mt-3 bg-green-900 rounded p-3">
              <p class="text-white text-sm font-bold">ğŸ“¥ å¾©å…ƒãƒ‡ãƒ¼ã‚¿</p>
              <p class="text-white text-sm">${data.sessions.length}ã‚»ãƒƒã‚·ãƒ§ãƒ³</p>
              ${data.settings ? '<p class="text-white text-sm">è¨­å®šã‚‚å¾©å…ƒã—ã¾ã™</p>' : ''}
              <div class="flex gap-2 mt-2">
                <button onclick="confirmJSONImport()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">å®Ÿè¡Œ</button>
                <button onclick="cancelJSONImport()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm">å–æ¶ˆ</button>
              </div>
            </div>`;
        } catch(err) { alert('JSONã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message); }
      };
      reader.readAsText(file); e.target.value = '';
    };

    window.confirmJSONImport = async () => {
      if (!pendingJSONImport) return;
      updateSyncStatus('syncing');
      try {
        // è¨­å®šã‚’å¾©å…ƒ
        if (pendingJSONImport.settings) {
          await setDoc(doc(db, 'groups', state.roomId, 'config', 'settings'), pendingJSONImport.settings);
        }
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¾©å…ƒ
        const batchSize = 500;
        for (let i = 0; i < pendingJSONImport.sessions.length; i += batchSize) {
          const batch = writeBatch(db);
          pendingJSONImport.sessions.slice(i, i + batchSize).forEach(s => {
            batch.set(doc(db, 'groups', state.roomId, 'sessions', String(s.id || s.date)), s);
          });
          await batch.commit();
        }
        updateSyncStatus('connected');
        alert(`${pendingJSONImport.sessions.length}ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼`);
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        updateSyncStatus('error');
      }
      pendingJSONImport = null;
      document.getElementById('importJSONPreview').innerHTML = '';
    };

    window.cancelJSONImport = () => {
      pendingJSONImport = null;
      document.getElementById('importJSONPreview').innerHTML = '';
    };

    let pendingImport = null;
    let pendingChipImport = null;

    window.importLegacy = (e) => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
          const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
          processLegacyData(json);
        } catch(err) { alert('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message); }
      };
      reader.readAsArrayBuffer(file); e.target.value = '';
    };

    function processLegacyData(data) {
      if (!data || !data.length) { alert('ãƒ‡ãƒ¼ã‚¿ãªã—'); return; }
      const playerCols = state.settings.players;
      const keys = Object.keys(data[0]);
      const missing = playerCols.filter(p => !keys.includes(p));
      if (missing.length) { alert(`åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${missing.join(', ')}\næ¤œå‡º: ${keys.join(', ')}`); return; }
      
      let dateCol = 'æ—¥ä»˜';
      if (!keys.includes(dateCol)) dateCol = keys[0];
      
      const sessionMap = {}; let count = 0;
      data.forEach(row => {
        let dateVal = row[dateCol]; if (!dateVal) return;
        let dateStr;
        if (typeof dateVal === 'number' || (!isNaN(dateVal) && parseInt(dateVal) > 40000)) {
          const d = new Date(new Date(1899, 11, 30).getTime() + parseInt(dateVal) * 86400000);
          dateStr = d.toISOString().split('T')[0];
        } else {
          const str = String(dateVal);
          if (str.includes('/')) {
            const parts = str.split('/');
            dateStr = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
          } else dateStr = str;
        }
        if (!sessionMap[dateStr]) sessionMap[dateStr] = { date: dateStr, players: playerCols, games: [], chips: [0,0,0,0] };
        sessionMap[dateStr].games.push({ scores: playerCols.map(p => parseInt(row[p]) || 0), yakuman: [] });
        count++;
      });
      const sessions = Object.values(sessionMap).map((s) => ({ ...s, id: s.date, savedAt: new Date().toISOString() }));
      if (!sessions.length) { alert('æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿ãªã—'); return; }
      const dates = Object.keys(sessionMap).sort();
      pendingImport = sessions;
      document.getElementById('importPreview').innerHTML = `
        <div class="mt-3 bg-gray-700 rounded p-3">
          <p class="text-white text-sm">${sessions.length}æ—¥ / ${count}ã‚²ãƒ¼ãƒ </p>
          <p class="text-white text-sm">${dates[0]} ã€œ ${dates[dates.length-1]}</p>
          <div class="flex gap-2 mt-2">
            <button onclick="confirmImport()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">å®Ÿè¡Œ</button>
            <button onclick="cancelImport()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm">å–æ¶ˆ</button>
          </div>
        </div>`;
    }

    window.confirmImport = async () => {
      if (!pendingImport) return;
      updateSyncStatus('syncing');
      try {
        const batchSize = 500;
        for (let i = 0; i < pendingImport.length; i += batchSize) {
          const batch = writeBatch(db);
          pendingImport.slice(i, i + batchSize).forEach(s => {
            batch.set(doc(db, 'groups', state.roomId, 'sessions', String(s.id)), s);
          });
          await batch.commit();
        }
        updateSyncStatus('connected');
        alert(`${pendingImport.length}ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼`);
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        updateSyncStatus('error');
      }
      pendingImport = null;
      document.getElementById('importPreview').innerHTML = '';
    };

    window.cancelImport = () => { pendingImport = null; pendingChipImport = null; document.getElementById('importPreview').innerHTML = ''; };

    window.importChip = (e) => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
          const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
          processChipData(json);
        } catch(err) { alert('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message); }
      };
      reader.readAsArrayBuffer(file); e.target.value = '';
    };

    function processChipData(data) {
      if (!data || !data.length) { alert('ãƒ‡ãƒ¼ã‚¿ãªã—'); return; }
      const playerCols = state.settings.players;
      const keys = Object.keys(data[0]);
      const missing = playerCols.filter(p => !keys.includes(p));
      if (missing.length) { alert(`åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${missing.join(', ')}\næ¤œå‡º: ${keys.join(', ')}`); return; }
      
      let dateCol = 'æ—¥ä»˜';
      if (!keys.includes(dateCol)) dateCol = keys[0];
      
      const chipMap = {};
      data.forEach(row => {
        let dateVal = row[dateCol]; if (!dateVal) return;
        let dateStr;
        if (typeof dateVal === 'number' || (!isNaN(dateVal) && parseInt(dateVal) > 40000)) {
          const d = new Date(new Date(1899, 11, 30).getTime() + parseInt(dateVal) * 86400000);
          dateStr = d.toISOString().split('T')[0];
        } else {
          const str = String(dateVal);
          if (str.includes('/')) {
            const parts = str.split('/');
            dateStr = `${parts[0]}-${parts[1].padStart(2, '0')}-${parts[2].padStart(2, '0')}`;
          } else dateStr = str;
        }
        if (!chipMap[dateStr]) chipMap[dateStr] = [0, 0, 0, 0];
        playerCols.forEach((p, i) => { chipMap[dateStr][i] += parseInt(row[p]) || 0; });
      });
      
      const dates = Object.keys(chipMap).sort();
      if (!dates.length) { alert('æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿ãªã—'); return; }
      pendingChipImport = chipMap;
      document.getElementById('importPreview').innerHTML = `
        <div class="mt-3 bg-orange-900 rounded p-3">
          <p class="text-white text-sm font-bold">ğŸ° ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿</p>
          <p class="text-white text-sm">${dates.length}æ—¥åˆ†</p>
          <p class="text-white text-sm">${dates[0]} ã€œ ${dates[dates.length-1]}</p>
          <div class="flex gap-2 mt-2">
            <button onclick="confirmChipImport()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">å®Ÿè¡Œ</button>
            <button onclick="cancelImport()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm">å–æ¶ˆ</button>
          </div>
        </div>`;
    }

    window.confirmChipImport = async () => {
      if (!pendingChipImport) return;
      updateSyncStatus('syncing');
      try {
        let updatedCount = 0;
        for (const [date, chips] of Object.entries(pendingChipImport)) {
          const session = state.sessions.find(s => s.date === date);
          if (session) {
            session.chips = chips;
            await saveSessionToFirebase(session);
            updatedCount++;
          }
        }
        updateSyncStatus('connected');
        alert(`${updatedCount}ä»¶ã®ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼`);
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        updateSyncStatus('error');
      }
      pendingChipImport = null;
      document.getElementById('importPreview').innerHTML = '';
    };

    window.deleteAllData = async () => {
      if (!confirm('æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      if (!confirm('æœ€çµ‚ç¢ºèªï¼šå…¨ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
      updateSyncStatus('syncing');
      try {
        const batch = writeBatch(db);
        state.sessions.forEach(s => {
          batch.delete(doc(db, 'groups', state.roomId, 'sessions', String(s.id)));
        });
        await batch.commit();
        updateSyncStatus('connected');
        alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      } catch (error) {
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        updateSyncStatus('error');
      }
    };

    // åˆæœŸåŒ–
    async function init() {
      const savedRoomId = getSavedRoomId();
      const savedAuthHash = getSavedAuthHash();
      
      if (!savedRoomId || !savedAuthHash) {
        showLoginScreen();
        return;
      }
      
      // ä¿å­˜æ¸ˆã¿ã®èªè¨¼æƒ…å ±ã§è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³
      try {
        const authDoc = await getDoc(doc(db, 'groups', savedRoomId, 'config', 'auth'));
        if (authDoc.exists() && authDoc.data().passwordHash === savedAuthHash) {
          state.roomId = savedRoomId;
          document.getElementById('syncStatus').style.display = 'block';
          startRealtimeSync();
        } else {
          clearSavedRoom();
          showLoginScreen();
        }
      } catch (e) {
        console.error('è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', e);
        showLoginScreen();
      }
    }

    init();
  </script>
</body>
</html>
