<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>ğŸ€„ éº»é›€ç²¾ç®—</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <style>
    * { -webkit-tap-highlight-color: transparent; }
    body { 
      overscroll-behavior: none; 
      background: #064e3b; 
      font-family: 'Meiryo', 'ãƒ¡ã‚¤ãƒªã‚ª', sans-serif;
      font-size: 16px;
    }
    .tab-btn { transition: all 0.2s; }
    .score-input { -webkit-appearance: none; -moz-appearance: textfield; }
    .score-input::-webkit-inner-spin-button { -webkit-appearance: none; }
    .text-xs { font-size: 0.85rem; }
    .text-sm { font-size: 0.95rem; }
    .text-base { font-size: 1.05rem; }
    .text-lg { font-size: 1.2rem; }
    .text-xl { font-size: 1.35rem; }
    .text-2xl { font-size: 1.6rem; }
    .sync-indicator { 
      position: fixed; 
      top: 10px; 
      right: 10px; 
      padding: 4px 8px; 
      border-radius: 4px; 
      font-size: 12px; 
      z-index: 100;
    }
  </style>
</head>
<body class="bg-green-900 min-h-screen">
  <div id="syncStatus" class="sync-indicator bg-yellow-600 text-white">æ¥ç¶šä¸­...</div>
  <div id="app" class="max-w-lg mx-auto p-3"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAwyfXpzsGm66aKvH-LG8klfwtIaMqN2jE",
      authDomain: "mahjong-score-21f84.firebaseapp.com",
      projectId: "mahjong-score-21f84",
      storageBucket: "mahjong-score-21f84.firebasestorage.app",
      messagingSenderId: "144373246004",
      appId: "1:144373246004:web:a23ab4f0f1e51e8b55c261"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const YAKUMAN_LIST = [
      'å››æš—åˆ»', 'å›½å£«ç„¡åŒ', 'å¤§ä¸‰å…ƒ', 'å­—ä¸€è‰²', 'å°å››å–œ', 'å¤§å››å–œ',
      'ç·‘ä¸€è‰²', 'æ¸…è€é ­', 'ä¹è“®å®ç‡ˆ', 'å››æ§“å­', 'å¤©å’Œ', 'åœ°å’Œ',
      'å››æš—åˆ»å˜é¨', 'å›½å£«ç„¡åŒ13é¢', 'ç´”æ­£ä¹è“®å®ç‡ˆ', 'ãã®ä»–'
    ];

    let state = {
      activeTab: 'input',
      settings: {
        basePoint: 30000,
        totalPoint: 100000,
        originPoint: 25000,
        uma: [30, 10, -10, -30],
        pointCoef: 100,
        chipCoef: 100,
      },
      sessions: [],
      currentSession: {
        id: null,
        date: new Date().toISOString().split('T')[0],
        players: ['ç€§è°·', 'çªªç”°', 'æ‰åŸ', 'éš…ç”°'],
        games: [],
        chips: [0, 0, 0, 0],
      },
      registeredPlayers: ['ç€§è°·', 'çªªç”°', 'æ‰åŸ', 'éš…ç”°'],
      showSettings: false,
    };

    function updateSyncStatus(status) {
      const el = document.getElementById('syncStatus');
      if (status === 'connected') {
        el.className = 'sync-indicator bg-green-600 text-white';
        el.textContent = 'ğŸŸ¢ åŒæœŸä¸­';
      } else if (status === 'syncing') {
        el.className = 'sync-indicator bg-yellow-600 text-white';
        el.textContent = 'ğŸ”„ ä¿å­˜ä¸­...';
      } else if (status === 'error') {
        el.className = 'sync-indicator bg-red-600 text-white';
        el.textContent = 'ğŸ”´ ã‚¨ãƒ©ãƒ¼';
      } else {
        el.className = 'sync-indicator bg-yellow-600 text-white';
        el.textContent = 'æ¥ç¶šä¸­...';
      }
    }

    async function saveSettingsToFirebase() {
      try {
        await setDoc(doc(db, 'config', 'settings'), state.settings);
      } catch (e) { console.error('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', e); }
    }

    async function saveSessionToFirebase(session) {
      try {
        updateSyncStatus('syncing');
        await setDoc(doc(db, 'sessions', String(session.id)), session);
        updateSyncStatus('connected');
      } catch (e) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        updateSyncStatus('error');
      }
    }

    async function deleteSessionFromFirebase(sessionId) {
      try {
        updateSyncStatus('syncing');
        await deleteDoc(doc(db, 'sessions', String(sessionId)));
        updateSyncStatus('connected');
      } catch (e) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e);
        updateSyncStatus('error');
      }
    }

    function startRealtimeSync() {
      const sessionsRef = collection(db, 'sessions');
      onSnapshot(sessionsRef, (snapshot) => {
        state.sessions = [];
        snapshot.forEach((doc) => state.sessions.push(doc.data()));
        // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
        state.sessions.sort((a, b) => b.date.localeCompare(a.date));
        updateSyncStatus('connected');
        render();
      }, (error) => {
        console.error('åŒæœŸã‚¨ãƒ©ãƒ¼:', error);
        updateSyncStatus('error');
      });

      onSnapshot(doc(db, 'config', 'settings'), (doc) => {
        if (doc.exists()) state.settings = { ...state.settings, ...doc.data() };
      });
    }

    function checkTotal(scores) {
      return scores.reduce((a,b) => a+b, 0) === state.settings.totalPoint;
    }

    function getRanks(scores) {
      const indexed = scores.map((s,i) => ({s,i}));
      indexed.sort((a,b) => b.s - a.s);
      const ranks = [0,0,0,0];
      indexed.forEach((x,r) => ranks[x.i] = r + 1);
      return ranks;
    }

    function calcGame(scores) {
      if (!checkTotal(scores)) return null;
      const ranks = getRanks(scores);
      const oka = ((state.settings.basePoint - state.settings.originPoint) * 4) / 1000;
      const results = scores.map((score, i) => {
        const base = (score - state.settings.basePoint) / 1000;
        const uma = state.settings.uma[ranks[i] - 1];
        const okaBonus = ranks[i] === 1 ? oka : 0;
        return base + uma + okaBonus;
      });
      return { ranks, results };
    }

    function calcSession(session) {
      const totals = [0,0,0,0];
      const rankCounts = [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];
      session.games.forEach(g => {
        const r = calcGame(g.scores);
        if (r) {
          r.results.forEach((v,i) => totals[i] += v);
          r.ranks.forEach((v,i) => rankCounts[i][v-1]++);
        }
      });
      return session.players.map((p,i) => ({
        player: p || `P${i+1}`,
        pointTotal: totals[i],
        pointAmount: totals[i] * state.settings.pointCoef,
        chipCount: session.chips[i],
        chipAmount: session.chips[i] * state.settings.chipCoef,
        total: totals[i] * state.settings.pointCoef + session.chips[i] * state.settings.chipCoef,
        rankCounts: rankCounts[i],
      }));
    }

    function getAllYakuman() {
      const list = [];
      state.sessions.forEach(session => {
        session.games.forEach((game) => {
          if (game.yakuman && game.yakuman.length > 0) {
            game.yakuman.forEach(yk => list.push({ date: session.date, ...yk }));
          }
        });
      });
      return list.sort((a,b) => b.date.localeCompare(a.date));
    }

    function getYakumanStats() {
      const stats = {};
      state.registeredPlayers.forEach(p => stats[p] = { count: 0 });
      getAllYakuman().forEach(yk => {
        if (stats[yk.player]) stats[yk.player].count++;
      });
      return stats;
    }

    function getPlayerStats() {
      const stats = {};
      state.sessions.forEach(session => {
        session.games.forEach(game => {
          const r = calcGame(game.scores);
          if (!r) return;
          session.players.forEach((player, i) => {
            if (!player) return;
            if (!stats[player]) {
              stats[player] = { name: player, games: 0, ranks: [0,0,0,0], totalPoints: 0, totalChips: 0 };
            }
            stats[player].games++;
            stats[player].ranks[r.ranks[i] - 1]++;
            stats[player].totalPoints += r.results[i];
          });
        });
        session.players.forEach((player, i) => {
          if (player && stats[player]) stats[player].totalChips += session.chips[i];
        });
      });

      const yakumanStats = getYakumanStats();
      Object.values(stats).forEach(s => {
        s.winRate = s.games > 0 ? ((s.ranks[0] / s.games) * 100).toFixed(1) : 0;
        s.avgRank = s.games > 0 ? ((s.ranks[0]*1 + s.ranks[1]*2 + s.ranks[2]*3 + s.ranks[3]*4) / s.games).toFixed(2) : 0;
        s.totalAmount = s.totalPoints * state.settings.pointCoef + s.totalChips * state.settings.chipCoef;
        s.yakumanCount = yakumanStats[s.name] ? yakumanStats[s.name].count : 0;
      });

      return Object.values(stats).sort((a,b) => b.totalAmount - a.totalAmount);
    }

    function render() {
      const app = document.getElementById('app');
      app.innerHTML = `
        <h1 class="text-xl font-bold text-white text-center mb-3">ğŸ€„ éº»é›€ç²¾ç®—</h1>
        <div class="flex gap-1 mb-4 overflow-x-auto pb-1">
          ${['input:ğŸ“å…¥åŠ›', 'history:ğŸ“šå±¥æ­´', 'report:ğŸ“Šæˆç¸¾', 'yakuman:ğŸ€„å½¹æº€', 'ranking:ğŸ†é †ä½', 'data:ğŸ’¾ç®¡ç†'].map(t => {
            const [id, label] = t.split(':');
            return `<button onclick="setTab('${id}')" class="tab-btn px-2 py-2 rounded text-xs whitespace-nowrap ${state.activeTab === id ? 'bg-yellow-600 text-white' : 'bg-gray-700 text-gray-300'}">${label}</button>`;
          }).join('')}
        </div>
        <div id="content"></div>
      `;
      const content = document.getElementById('content');
      if (state.activeTab === 'input') renderInput(content);
      else if (state.activeTab === 'history') renderHistory(content);
      else if (state.activeTab === 'report') renderReport(content);
      else if (state.activeTab === 'yakuman') renderYakuman(content);
      else if (state.activeTab === 'ranking') renderRanking(content);
      else if (state.activeTab === 'data') renderData(content);
    }

    window.setTab = (tab) => { state.activeTab = tab; render(); };

    function renderInput(el) {
      const cs = state.currentSession;
      const chipTotal = cs.chips.reduce((a,b) => a+b, 0);
      const chipValid = chipTotal === 0;

      el.innerHTML = `
        <div class="flex justify-end mb-2">
          <button onclick="toggleSettings()" class="bg-yellow-600 text-white px-3 py-1 rounded text-sm">âš™ï¸è¨­å®š</button>
        </div>
        ${state.showSettings ? `
        <div class="bg-gray-800 rounded-lg p-3 mb-3">
          <div class="grid grid-cols-2 gap-2 text-sm">
            <div><label class="text-gray-300 text-xs">åŸºæº–ç‚¹</label><input type="number" value="${state.settings.basePoint}" onchange="updateSetting('basePoint', this.value)" class="w-full p-2 rounded bg-gray-700 text-white score-input"></div>
            <div><label class="text-gray-300 text-xs">åˆè¨ˆç‚¹</label><input type="number" value="${state.settings.totalPoint}" onchange="updateSetting('totalPoint', this.value)" class="w-full p-2 rounded bg-gray-700 text-white score-input"></div>
            <div><label class="text-gray-300 text-xs">ç‚¹æ•°ä¿‚æ•°</label><input type="number" value="${state.settings.pointCoef}" onchange="updateSetting('pointCoef', this.value)" class="w-full p-2 rounded bg-gray-700 text-white score-input"></div>
            <div><label class="text-gray-300 text-xs">ãƒãƒƒãƒ—ä¿‚æ•°</label><input type="number" value="${state.settings.chipCoef}" onchange="updateSetting('chipCoef', this.value)" class="w-full p-2 rounded bg-gray-700 text-white score-input"></div>
          </div>
          <div class="mt-2">
            <label class="text-gray-300 text-xs">ã‚¦ãƒ</label>
            <div class="grid grid-cols-4 gap-1">
              ${state.settings.uma.map((u,i) => `<input type="number" value="${u}" onchange="updateUma(${i}, this.value)" class="p-1 rounded bg-gray-700 text-white text-center text-sm score-input">`).join('')}
            </div>
          </div>
        </div>
        ` : ''}
        <div class="bg-gray-800 rounded-lg p-3 mb-3">
          <input type="date" value="${cs.date}" onchange="updateDate(this.value)" class="w-full p-2 rounded bg-gray-700 text-white mb-2">
          <div class="grid grid-cols-2 gap-2">
            ${cs.players.map((p,i) => `<input value="${p}" onchange="updatePlayer(${i}, this.value)" placeholder="æ°å${i+1}" class="p-2 rounded bg-gray-700 text-white text-sm">`).join('')}
          </div>
        </div>
        <div class="bg-gray-800 rounded-lg p-3 mb-3">
          <div class="flex justify-between items-center mb-2">
            <span class="text-white font-bold text-sm">ã‚²ãƒ¼ãƒ </span>
            <button onclick="addGame()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm">+è¿½åŠ </button>
          </div>
          ${cs.games.length === 0 ? '<p class="text-gray-400 text-center py-4 text-sm">ã‚²ãƒ¼ãƒ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</p>' : 
            cs.games.map((g,gi) => {
              const valid = checkTotal(g.scores);
              const result = calcGame(g.scores);
              const total = g.scores.reduce((a,b) => a+b, 0);
              const yakumanList = g.yakuman || [];
              return `
              <div class="p-2 rounded mb-2 ${valid ? 'bg-gray-700' : 'bg-red-900'}">
                <div class="flex justify-between items-center mb-1">
                  <span class="text-white text-sm">#${gi+1}</span>
                  <div class="flex items-center gap-2">
                    <span class="text-xs ${valid ? 'text-green-400' : 'text-red-400'}">è¨ˆ:${total.toLocaleString()}</span>
                    <button onclick="removeGame(${gi})" class="text-red-400 text-xs">âœ•</button>
                  </div>
                </div>
                <div class="grid grid-cols-4 gap-1 mb-2">
                  ${g.scores.map((s,pi) => `
                    <div>
                      <input type="number" value="${s||''}" onchange="updateScore(${gi},${pi},this.value)" class="w-full p-1 rounded bg-gray-600 text-white text-center text-sm score-input">
                      ${result ? `<div class="text-xs text-center mt-1"><span class="text-yellow-400">${result.ranks[pi]}ä½</span> <span class="${result.results[pi]>=0?'text-green-400':'text-red-400'}">${result.results[pi]>=0?'+':''}${result.results[pi]}</span></div>` : ''}
                    </div>
                  `).join('')}
                </div>
                <div class="border-t border-gray-600 pt-2 mt-2">
                  <div class="flex justify-between items-center mb-1">
                    <span class="text-yellow-400 text-xs font-bold">ğŸ€„ å½¹æº€</span>
                    <button onclick="addYakuman(${gi})" class="bg-yellow-600 text-white px-2 py-0.5 rounded text-xs">+è¿½åŠ </button>
                  </div>
                  ${yakumanList.map((yk, yi) => `
                    <div class="bg-gray-600 rounded p-2 mb-1 text-xs">
                      <div class="flex justify-between items-center">
                        <span class="text-yellow-300 font-bold">${yk.yaku}</span>
                        <button onclick="removeYakuman(${gi},${yi})" class="text-red-400">âœ•</button>
                      </div>
                      <div class="text-gray-300">${yk.player} / ${yk.type}${yk.type === 'ãƒ­ãƒ³' && yk.from ? ` â† ${yk.from}` : ''}</div>
                    </div>
                  `).join('')}
                </div>
              </div>`;
            }).join('')}
        </div>
        <div class="rounded-lg p-3 mb-3 ${chipValid ? 'bg-gray-800' : 'bg-red-900'}">
          <div class="flex justify-between items-center mb-2">
            <span class="text-white font-bold text-sm">ãƒãƒƒãƒ—</span>
            <span class="text-xs ${chipValid ? 'text-green-400' : 'text-red-400'}">è¨ˆ:${chipTotal}</span>
          </div>
          <div class="grid grid-cols-4 gap-1">
            ${cs.chips.map((c,i) => `<input type="number" value="${c||''}" onchange="updateChip(${i},this.value)" placeholder="0" class="p-1 rounded bg-gray-700 text-white text-center text-sm score-input">`).join('')}
          </div>
        </div>
        ${cs.games.length > 0 ? `
        <div class="bg-gray-800 rounded-lg p-3 mb-3 overflow-x-auto">
          <table class="w-full text-white text-xs">
            <thead><tr class="border-b border-gray-600">
              <th class="text-left p-1">åå‰</th><th class="text-right p-1">pt</th><th class="text-right p-1">å††</th><th class="text-right p-1">chip</th><th class="text-right p-1">è¨ˆ</th>
            </tr></thead>
            <tbody>
              ${calcSession(cs).map(r => `
                <tr class="border-b border-gray-700">
                  <td class="p-1">${r.player}</td>
                  <td class="text-right p-1 ${r.pointTotal>=0?'text-green-400':'text-red-400'}">${r.pointTotal}</td>
                  <td class="text-right p-1 ${r.pointAmount>=0?'text-green-400':'text-red-400'}">${r.pointAmount.toLocaleString()}</td>
                  <td class="text-right p-1 ${r.chipAmount>=0?'text-green-400':'text-red-400'}">${r.chipAmount.toLocaleString()}</td>
                  <td class="text-right p-1 font-bold ${r.total>=0?'text-green-400':'text-red-400'}">${r.total.toLocaleString()}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
        ` : ''}
        <button onclick="saveSession()" class="w-full bg-green-600 text-white py-3 rounded-lg font-bold">ğŸ’¾ ä¿å­˜</button>
      `;
    }

    window.toggleSettings = () => { state.showSettings = !state.showSettings; render(); };
    window.updateSetting = (key, val) => { state.settings[key] = parseInt(val)||0; saveSettingsToFirebase(); render(); };
    window.updateUma = (i, val) => { state.settings.uma[i] = parseInt(val)||0; saveSettingsToFirebase(); render(); };
    window.updateDate = (val) => { state.currentSession.date = val; render(); };
    window.updatePlayer = (i, val) => { state.currentSession.players[i] = val; render(); };
    window.addGame = () => { state.currentSession.games.push({scores:[0,0,0,0], yakuman: []}); render(); };
    window.removeGame = (i) => { state.currentSession.games.splice(i,1); render(); };
    window.updateScore = (gi, pi, val) => { state.currentSession.games[gi].scores[pi] = parseInt(val)||0; render(); };
    window.updateChip = (i, val) => { state.currentSession.chips[i] = parseInt(val)||0; render(); };

    window.addYakuman = (gi) => {
      const players = state.currentSession.players;
      document.body.insertAdjacentHTML('beforeend', `
        <div id="yakumanModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
          <div class="bg-gray-800 rounded-lg p-4 w-full max-w-sm">
            <h3 class="text-white font-bold mb-3">ğŸ€„ å½¹æº€ã‚’è¿½åŠ </h3>
            <div class="mb-3">
              <label class="text-gray-300 text-sm">å’Œäº†è€…</label>
              <select id="yk_player" class="w-full p-2 rounded bg-gray-700 text-white">
                ${players.map(p => `<option value="${p}">${p}</option>`).join('')}
              </select>
            </div>
            <div class="mb-3">
              <label class="text-gray-300 text-sm">å½¹å</label>
              <select id="yk_yaku" class="w-full p-2 rounded bg-gray-700 text-white" onchange="document.getElementById('yk_yaku_other').classList.toggle('hidden', this.value !== 'ãã®ä»–')">
                ${YAKUMAN_LIST.map(y => `<option value="${y}">${y}</option>`).join('')}
              </select>
              <input id="yk_yaku_other" type="text" placeholder="ãã®ä»–ã®å½¹å" class="w-full p-2 rounded bg-gray-700 text-white mt-1 hidden">
            </div>
            <div class="mb-3">
              <label class="text-gray-300 text-sm">ãƒ„ãƒ¢/ãƒ­ãƒ³</label>
              <select id="yk_type" class="w-full p-2 rounded bg-gray-700 text-white" onchange="document.getElementById('yk_from_div').classList.toggle('hidden', this.value !== 'ãƒ­ãƒ³')">
                <option value="ãƒ„ãƒ¢">ãƒ„ãƒ¢</option>
                <option value="ãƒ­ãƒ³">ãƒ­ãƒ³</option>
              </select>
            </div>
            <div id="yk_from_div" class="mb-3 hidden">
              <label class="text-gray-300 text-sm">æ”¾éŠƒè€…</label>
              <select id="yk_from" class="w-full p-2 rounded bg-gray-700 text-white">
                ${players.map(p => `<option value="${p}">${p}</option>`).join('')}
              </select>
            </div>
            <div class="flex gap-2">
              <button onclick="confirmYakuman(${gi})" class="flex-1 bg-yellow-600 text-white py-2 rounded font-bold">è¿½åŠ </button>
              <button onclick="document.getElementById('yakumanModal').remove()" class="flex-1 bg-gray-600 text-white py-2 rounded">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
          </div>
        </div>
      `);
    };

    window.confirmYakuman = (gi) => {
      let yaku = document.getElementById('yk_yaku').value;
      if (yaku === 'ãã®ä»–') yaku = document.getElementById('yk_yaku_other').value || 'ãã®ä»–';
      const type = document.getElementById('yk_type').value;
      const from = type === 'ãƒ­ãƒ³' ? document.getElementById('yk_from').value : null;
      if (!state.currentSession.games[gi].yakuman) state.currentSession.games[gi].yakuman = [];
      state.currentSession.games[gi].yakuman.push({
        player: document.getElementById('yk_player').value,
        yaku, type, from
      });
      document.getElementById('yakumanModal').remove();
      render();
    };

    window.removeYakuman = (gi, yi) => { state.currentSession.games[gi].yakuman.splice(yi, 1); render(); };

    window.saveSession = async () => {
      const cs = state.currentSession;
      if (cs.games.length === 0) { alert('ã‚²ãƒ¼ãƒ ã‚’è¿½åŠ ã—ã¦ãã ã•ã„'); return; }
      if (cs.games.filter(g => checkTotal(g.scores)).length === 0) { alert('æœ‰åŠ¹ãªã‚²ãƒ¼ãƒ ãŒã‚ã‚Šã¾ã›ã‚“'); return; }
      const toSave = { ...cs, id: cs.date, savedAt: new Date().toISOString() };
      await saveSessionToFirebase(toSave);
      state.currentSession = { id: null, date: new Date().toISOString().split('T')[0], players: ['ç€§è°·', 'çªªç”°', 'æ‰åŸ', 'éš…ç”°'], games: [], chips: [0,0,0,0] };
      alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
      render();
    };

    function renderHistory(el) {
      if (state.sessions.length === 0) { el.innerHTML = '<p class="text-gray-400 text-center py-8">å±¥æ­´ãªã—</p>'; return; }
      el.innerHTML = [...state.sessions].sort((a,b) => b.date.localeCompare(a.date)).map(s => {
        const results = calcSession(s);
        const ykCount = s.games.reduce((sum, g) => sum + (g.yakuman ? g.yakuman.length : 0), 0);
        return `
        <div class="bg-gray-800 rounded-lg p-3 mb-3">
          <div class="flex justify-between items-center mb-2">
            <div><span class="text-white font-bold">${s.date}</span>${ykCount > 0 ? `<span class="ml-2 bg-yellow-600 text-white px-2 py-0.5 rounded text-xs">å½¹æº€${ykCount}</span>` : ''}</div>
            <div class="flex gap-2">
              <button onclick="editSession('${s.id}')" class="text-blue-400 text-xs">ç·¨é›†</button>
              <button onclick="deleteSession('${s.id}')" class="text-red-400 text-xs">å‰Šé™¤</button>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            ${results.map(r => `<div class="bg-gray-700 rounded p-2"><div class="text-gray-300 text-xs">${r.player}</div><div class="font-bold ${r.total>=0?'text-green-400':'text-red-400'}">${r.total>=0?'+':''}${r.total.toLocaleString()}å††</div></div>`).join('')}
          </div>
        </div>`;
      }).join('');
    }

    window.editSession = (id) => {
      const s = state.sessions.find(x => String(x.id) === String(id));
      if (s) { state.currentSession = JSON.parse(JSON.stringify(s)); state.activeTab = 'input'; render(); }
    };
    window.deleteSession = async (id) => { if (confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) await deleteSessionFromFirebase(id); };

    function renderReport(el) {
      const stats = getPlayerStats();
      el.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-3 mb-3 overflow-x-auto">
          <table class="w-full text-white text-xs">
            <thead><tr class="border-b border-gray-600"><th class="text-left p-1">åå‰</th><th class="text-right p-1">å±€æ•°</th><th class="text-right p-1">å‹ç‡</th><th class="text-right p-1">å¹³é †</th><th class="text-right p-1">å½¹æº€</th><th class="text-right p-1">åæ”¯</th></tr></thead>
            <tbody>${stats.map(s => `<tr class="border-b border-gray-700"><td class="p-1">${s.name}</td><td class="text-right p-1">${s.games}</td><td class="text-right p-1">${s.winRate}%</td><td class="text-right p-1">${s.avgRank}</td><td class="text-right p-1 text-yellow-400">${s.yakumanCount}</td><td class="text-right p-1 font-bold ${s.totalAmount>=0?'text-green-400':'text-red-400'}">${s.totalAmount.toLocaleString()}</td></tr>`).join('')}</tbody>
          </table>
        </div>
        <div class="bg-gray-800 rounded-lg p-3">
          <h3 class="text-white font-bold mb-2 text-sm">é †ä½åˆ†å¸ƒ</h3>
          ${stats.map(s => `<div class="mb-2"><div class="text-gray-300 text-xs mb-1">${s.name}</div><div class="flex gap-1"><span class="bg-yellow-600 text-white px-2 py-1 rounded text-xs">1ä½:${s.ranks[0]}</span><span class="bg-gray-500 text-white px-2 py-1 rounded text-xs">2ä½:${s.ranks[1]}</span><span class="bg-orange-700 text-white px-2 py-1 rounded text-xs">3ä½:${s.ranks[2]}</span><span class="bg-gray-700 text-white px-2 py-1 rounded text-xs">4ä½:${s.ranks[3]}</span></div></div>`).join('')}
        </div>
      `;
    }

    function renderYakuman(el) {
      const all = getAllYakuman();
      const stats = getYakumanStats();
      el.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-3 mb-3">
          <h3 class="text-white font-bold mb-2">ğŸ€„ å½¹æº€å›æ•°</h3>
          <div class="grid grid-cols-2 gap-2">
            ${Object.entries(stats).map(([name, data]) => `<div class="bg-gray-700 rounded p-2 text-center"><div class="text-gray-300 text-sm">${name}</div><div class="text-yellow-400 text-2xl font-bold">${data.count}</div></div>`).join('')}
          </div>
        </div>
        <div class="bg-gray-800 rounded-lg p-3">
          <h3 class="text-white font-bold mb-2">ğŸ“œ å½¹æº€å±¥æ­´</h3>
          ${all.length === 0 ? '<p class="text-gray-400 text-center py-4 text-sm">å½¹æº€è¨˜éŒ²ãªã—</p>' : all.map(yk => `<div class="bg-gray-700 rounded p-2 mb-2"><div class="flex justify-between items-center"><span class="text-yellow-400 font-bold">${yk.yaku}</span><span class="text-gray-400 text-xs">${yk.date}</span></div><div class="text-gray-300 text-sm">${yk.player} / ${yk.type}${yk.type === 'ãƒ­ãƒ³' && yk.from ? ` â† ${yk.from}` : ''}</div></div>`).join('')}
        </div>
      `;
    }

    function renderRanking(el) {
      const stats = getPlayerStats();
      const medal = (i) => i===0?'ğŸ¥‡':i===1?'ğŸ¥ˆ':i===2?'ğŸ¥‰':`${i+1}.`;
      el.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-3 mb-3"><h3 class="text-white font-bold mb-2">ğŸ’° åæ”¯</h3>${stats.map((s,i) => `<div class="flex justify-between py-1 border-b border-gray-700"><span class="text-white">${medal(i)} ${s.name}</span><span class="${s.totalAmount>=0?'text-green-400':'text-red-400'}">${s.totalAmount.toLocaleString()}å††</span></div>`).join('')}</div>
        <div class="bg-gray-800 rounded-lg p-3 mb-3"><h3 class="text-white font-bold mb-2">ğŸ¯ å‹ç‡</h3>${[...stats].sort((a,b) => b.winRate - a.winRate).map((s,i) => `<div class="flex justify-between py-1 border-b border-gray-700"><span class="text-white">${medal(i)} ${s.name}</span><span class="text-yellow-400">${s.winRate}%</span></div>`).join('')}</div>
        <div class="bg-gray-800 rounded-lg p-3 mb-3"><h3 class="text-white font-bold mb-2">ğŸ€„ å½¹æº€</h3>${[...stats].sort((a,b) => b.yakumanCount - a.yakumanCount).map((s,i) => `<div class="flex justify-between py-1 border-b border-gray-700"><span class="text-white">${medal(i)} ${s.name}</span><span class="text-yellow-400">${s.yakumanCount}å›</span></div>`).join('')}</div>
        <div class="bg-gray-800 rounded-lg p-3"><h3 class="text-white font-bold mb-2">ğŸ“Š å¹³å‡é †ä½</h3>${[...stats].sort((a,b) => a.avgRank - b.avgRank).map((s,i) => `<div class="flex justify-between py-1 border-b border-gray-700"><span class="text-white">${medal(i)} ${s.name}</span><span class="text-blue-400">${s.avgRank}</span></div>`).join('')}</div>
      `;
    }

    function renderData(el) {
      el.innerHTML = `
        <div class="bg-gray-800 rounded-lg p-4 mb-3">
          <h3 class="text-white font-bold mb-2">â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ</h3>
          <p class="text-green-400 text-sm">ğŸŸ¢ Firebaseã«è‡ªå‹•åŒæœŸä¸­</p>
          <p class="text-gray-400 text-xs mt-1">å…¨å“¡ãŒåŒã˜URLã‚’é–‹ãã¨åŒã˜ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã‚Œã¾ã™</p>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 mb-3">
          <h3 class="text-white font-bold mb-2">ğŸ“¤ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
          <button onclick="exportData()" class="w-full bg-blue-600 text-white py-2 rounded">JSONã§ä¿å­˜</button>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 mb-3">
          <h3 class="text-white font-bold mb-2">ğŸ“‹ éå»ãƒ‡ãƒ¼ã‚¿ï¼ˆExcel/CSVï¼‰</h3>
          <p class="text-gray-400 text-xs mb-2">å›ºå®š: ç€§è°·, çªªç”°, æ‰åŸ, éš…ç”°</p>
          <label class="block w-full bg-purple-600 text-white py-2 rounded text-center cursor-pointer mb-2">ç‚¹æ•°ãƒ‡ãƒ¼ã‚¿èª­è¾¼<input type="file" accept=".xlsx,.xls,.csv" onchange="importLegacy(event)" class="hidden"></label>
          <label class="block w-full bg-orange-600 text-white py-2 rounded text-center cursor-pointer">ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿èª­è¾¼<input type="file" accept=".xlsx,.xls,.csv" onchange="importChip(event)" class="hidden"></label>
          <div id="importPreview"></div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 mb-3">
          <h3 class="text-white font-bold mb-2">ğŸ“ˆ çµ±è¨ˆ</h3>
          <div class="grid grid-cols-3 gap-2 text-center">
            <div class="bg-gray-700 rounded p-2"><div class="text-2xl font-bold text-white">${state.sessions.length}</div><div class="text-gray-400 text-xs">ã‚»ãƒƒã‚·ãƒ§ãƒ³</div></div>
            <div class="bg-gray-700 rounded p-2"><div class="text-2xl font-bold text-white">${state.sessions.reduce((s,x) => s + x.games.length, 0)}</div><div class="text-gray-400 text-xs">ã‚²ãƒ¼ãƒ </div></div>
            <div class="bg-gray-700 rounded p-2"><div class="text-2xl font-bold text-yellow-400">${getAllYakuman().length}</div><div class="text-gray-400 text-xs">å½¹æº€</div></div>
          </div>
        </div>
        <div class="bg-gray-800 rounded-lg p-4 mb-3">
          <h3 class="text-white font-bold mb-2">âš ï¸ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</h3>
          <p class="text-gray-400 text-xs mb-2">Firebaseã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
          <button onclick="deleteAllData()" class="w-full bg-red-600 text-white py-2 rounded">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
        </div>
      `;
    }

    window.exportData = () => {
      const data = { sessions: state.sessions, settings: state.settings };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
      a.download = `mahjong_${new Date().toISOString().split('T')[0]}.json`; a.click();
    };

    let pendingImport = null;
    window.importLegacy = (e) => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
          const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
          processLegacyData(json);
        } catch(err) { alert('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message); }
      };
      reader.readAsArrayBuffer(file); e.target.value = '';
    };

    function processLegacyData(data) {
      if (!data || !data.length) { alert('ãƒ‡ãƒ¼ã‚¿ãªã—'); return; }
      const playerCols = ['ç€§è°·', 'çªªç”°', 'æ‰åŸ', 'éš…ç”°'];
      const keys = Object.keys(data[0]);
      const missing = playerCols.filter(p => !keys.includes(p));
      if (missing.length) { alert(`åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${missing.join(', ')}\næ¤œå‡º: ${keys.join(', ')}`); return; }
      
      // æ—¥ä»˜åˆ—ã‚’æ¢ã™
      let dateCol = 'æ—¥ä»˜';
      if (!keys.includes(dateCol)) {
        dateCol = keys[0];
      }
      
      const sessionMap = {}; let count = 0;
      data.forEach(row => {
        let dateVal = row[dateCol]; if (!dateVal) return;
        let dateStr;
        
        if (typeof dateVal === 'number' || (!isNaN(dateVal) && parseInt(dateVal) > 40000)) {
          // Excelã‚·ãƒªã‚¢ãƒ«å€¤
          const d = new Date(new Date(1899, 11, 30).getTime() + parseInt(dateVal) * 86400000);
          dateStr = d.toISOString().split('T')[0];
        } else {
          // æ–‡å­—åˆ—ã®æ—¥ä»˜ï¼ˆ2024/1/27 ã‚„ 2024-01-27 å½¢å¼ï¼‰
          const str = String(dateVal);
          if (str.includes('/')) {
            const parts = str.split('/');
            const year = parts[0];
            const month = parts[1].padStart(2, '0');
            const day = parts[2].padStart(2, '0');
            dateStr = `${year}-${month}-${day}`;
          } else {
            dateStr = str;
          }
        }
        
        if (!sessionMap[dateStr]) sessionMap[dateStr] = { date: dateStr, players: playerCols, games: [], chips: [0,0,0,0] };
        sessionMap[dateStr].games.push({ scores: playerCols.map(p => parseInt(row[p]) || 0), yakuman: [] });
        count++;
      });
      const sessions = Object.values(sessionMap).map((s) => ({ ...s, id: s.date, savedAt: new Date().toISOString() }));
      if (!sessions.length) { alert('æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿ãªã—'); return; }
      const dates = Object.keys(sessionMap).sort();
      pendingImport = sessions;
      document.getElementById('importPreview').innerHTML = `
        <div class="mt-3 bg-gray-700 rounded p-3">
          <p class="text-white text-sm">${sessions.length}æ—¥ / ${count}ã‚²ãƒ¼ãƒ </p>
          <p class="text-white text-sm">${dates[0]} ã€œ ${dates[dates.length-1]}</p>
          <div class="flex gap-2 mt-2">
            <button onclick="confirmImport()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">å®Ÿè¡Œ</button>
            <button onclick="cancelImport()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm">å–æ¶ˆ</button>
          </div>
        </div>`;
    }

    window.confirmImport = async () => {
      if (!pendingImport) return;
      updateSyncStatus('syncing');
      
      try {
        // ãƒãƒƒãƒå‡¦ç†ï¼ˆ500ä»¶ãšã¤ï¼‰
        const batchSize = 500;
        let savedCount = 0;
        for (let i = 0; i < pendingImport.length; i += batchSize) {
          const batch = writeBatch(db);
          const chunk = pendingImport.slice(i, i + batchSize);
          chunk.forEach(s => {
            const docRef = doc(db, 'sessions', String(s.id));
            batch.set(docRef, s);
          });
          await batch.commit();
          savedCount += chunk.length;
          console.log(`ä¿å­˜å®Œäº†: ${savedCount}/${pendingImport.length}`);
        }
        
        updateSyncStatus('connected');
        alert(`${pendingImport.length}ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã—ãŸï¼`);
      } catch (error) {
        console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
        updateSyncStatus('error');
      }
      
      pendingImport = null; 
      document.getElementById('importPreview').innerHTML = '';
    };
    window.cancelImport = () => { pendingImport = null; pendingChipImport = null; document.getElementById('importPreview').innerHTML = ''; };

    // ãƒãƒƒãƒ—ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    let pendingChipImport = null;
    
    window.importChip = (e) => {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const wb = XLSX.read(new Uint8Array(ev.target.result), { type: 'array' });
          const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
          processChipData(json);
        } catch(err) { alert('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + err.message); }
      };
      reader.readAsArrayBuffer(file); e.target.value = '';
    };

    function processChipData(data) {
      if (!data || !data.length) { alert('ãƒ‡ãƒ¼ã‚¿ãªã—'); return; }
      const playerCols = ['ç€§è°·', 'çªªç”°', 'æ‰åŸ', 'éš…ç”°'];
      const keys = Object.keys(data[0]);
      const missing = playerCols.filter(p => !keys.includes(p));
      if (missing.length) { alert(`åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${missing.join(', ')}\næ¤œå‡º: ${keys.join(', ')}`); return; }
      
      // æ—¥ä»˜åˆ—ã‚’æ¢ã™ï¼ˆã€Œæ—¥ä»˜ã€ã¾ãŸã¯æœ€åˆã®åˆ—ï¼‰
      let dateCol = 'æ—¥ä»˜';
      if (!keys.includes(dateCol)) {
        // æœ€åˆã®åˆ—ã‚’æ—¥ä»˜åˆ—ã¨ã—ã¦ä½¿ç”¨
        dateCol = keys[0];
      }
      
      // æ—¥ä»˜ã”ã¨ã«ãƒãƒƒãƒ—ã‚’åˆè¨ˆ
      const chipMap = {};
      data.forEach(row => {
        let dateVal = row[dateCol]; if (!dateVal) return;
        let dateStr;
        
        if (typeof dateVal === 'number' || (!isNaN(dateVal) && parseInt(dateVal) > 40000)) {
          // Excelã‚·ãƒªã‚¢ãƒ«å€¤
          const d = new Date(new Date(1899, 11, 30).getTime() + parseInt(dateVal) * 86400000);
          dateStr = d.toISOString().split('T')[0];
        } else {
          // æ–‡å­—åˆ—ã®æ—¥ä»˜ï¼ˆ2024/1/27 ã‚„ 2024-01-27 å½¢å¼ï¼‰
          const str = String(dateVal);
          if (str.includes('/')) {
            const parts = str.split('/');
            const year = parts[0];
            const month = parts[1].padStart(2, '0');
            const day = parts[2].padStart(2, '0');
            dateStr = `${year}-${month}-${day}`;
          } else {
            dateStr = str;
          }
        }
        
        if (!chipMap[dateStr]) chipMap[dateStr] = [0, 0, 0, 0];
        playerCols.forEach((p, i) => {
          chipMap[dateStr][i] += parseInt(row[p]) || 0;
        });
      });
      
      const dates = Object.keys(chipMap).sort();
      if (!dates.length) { alert('æœ‰åŠ¹ãƒ‡ãƒ¼ã‚¿ãªã—'); return; }
      
      pendingChipImport = chipMap;
      
      document.getElementById('importPreview').innerHTML = `
        <div class="mt-3 bg-orange-900 rounded p-3">
          <p class="text-white text-sm font-bold">ğŸ° ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿</p>
          <p class="text-white text-sm">${dates.length}æ—¥åˆ†</p>
          <p class="text-white text-sm">${dates[0]} ã€œ ${dates[dates.length-1]}</p>
          <div class="flex gap-2 mt-2">
            <button onclick="confirmChipImport()" class="bg-green-600 text-white px-3 py-1 rounded text-sm">å®Ÿè¡Œ</button>
            <button onclick="cancelImport()" class="bg-gray-600 text-white px-3 py-1 rounded text-sm">å–æ¶ˆ</button>
          </div>
        </div>`;
    }

    window.confirmChipImport = async () => {
      if (!pendingChipImport) return;
      updateSyncStatus('syncing');
      
      try {
        let updatedCount = 0;
        let notFoundDates = [];
        
        for (const [date, chips] of Object.entries(pendingChipImport)) {
          // åŒã˜æ—¥ä»˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ¢ã™
          const session = state.sessions.find(s => s.date === date);
          if (session) {
            session.chips = chips;
            await saveSessionToFirebase(session);
            updatedCount++;
          } else {
            notFoundDates.push(date);
          }
        }
        
        updateSyncStatus('connected');
        let msg = `${updatedCount}ä»¶ã®ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼`;
        if (notFoundDates.length > 0) {
          msg += `\n\nâš ï¸ ${notFoundDates.length}ä»¶ã¯è©²å½“ã‚»ãƒƒã‚·ãƒ§ãƒ³ãªã—:\n${notFoundDates.slice(0, 5).join(', ')}${notFoundDates.length > 5 ? '...' : ''}`;
        }
        alert(msg);
      } catch (error) {
        console.error('ãƒãƒƒãƒ—ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
        updateSyncStatus('error');
      }
      
      pendingChipImport = null;
      document.getElementById('importPreview').innerHTML = '';
    };

    window.deleteAllData = async () => {
      if (!confirm('æœ¬å½“ã«å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
      if (!confirm('æœ€çµ‚ç¢ºèªï¼šå…¨ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) return;
      
      updateSyncStatus('syncing');
      try {
        const batch = writeBatch(db);
        state.sessions.forEach(s => {
          const docRef = doc(db, 'sessions', String(s.id));
          batch.delete(docRef);
        });
        await batch.commit();
        
        // è¨­å®šã‚‚å‰Šé™¤
        await deleteDoc(doc(db, 'config', 'settings'));
        
        updateSyncStatus('connected');
        alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message);
        updateSyncStatus('error');
      }
    };

    startRealtimeSync();
    render();
  </script>
</body>
</html>